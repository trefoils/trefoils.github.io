<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>TCP | Trefoil</title>
    <meta name="generator" content="VuePress 1.5.3">
    
    <meta name="description" content="井底之蛙，怎知天大。孤峰之脚，方知人小">
    <link rel="preload" href="/assets/css/0.styles.08f75515.css" as="style"><link rel="preload" href="/assets/js/app.af13c7e6.js" as="script"><link rel="preload" href="/assets/js/2.0f0c28b9.js" as="script"><link rel="preload" href="/assets/js/17.d3e472d1.js" as="script"><link rel="prefetch" href="/assets/js/10.7b14cb97.js"><link rel="prefetch" href="/assets/js/11.f683145f.js"><link rel="prefetch" href="/assets/js/12.6b8958ab.js"><link rel="prefetch" href="/assets/js/13.dcd7c486.js"><link rel="prefetch" href="/assets/js/14.0e64ef68.js"><link rel="prefetch" href="/assets/js/15.3738b4ad.js"><link rel="prefetch" href="/assets/js/16.6d2a0b84.js"><link rel="prefetch" href="/assets/js/18.7f325e10.js"><link rel="prefetch" href="/assets/js/19.81a2113b.js"><link rel="prefetch" href="/assets/js/20.8a409f80.js"><link rel="prefetch" href="/assets/js/21.84d42972.js"><link rel="prefetch" href="/assets/js/22.64df382b.js"><link rel="prefetch" href="/assets/js/23.bbac33c9.js"><link rel="prefetch" href="/assets/js/24.dbe1f212.js"><link rel="prefetch" href="/assets/js/25.536f91b6.js"><link rel="prefetch" href="/assets/js/26.8919ff36.js"><link rel="prefetch" href="/assets/js/27.8078dabf.js"><link rel="prefetch" href="/assets/js/28.79cf8b47.js"><link rel="prefetch" href="/assets/js/29.d528e890.js"><link rel="prefetch" href="/assets/js/3.7e03a49a.js"><link rel="prefetch" href="/assets/js/30.953c29ea.js"><link rel="prefetch" href="/assets/js/31.7ba64e73.js"><link rel="prefetch" href="/assets/js/32.a0a01885.js"><link rel="prefetch" href="/assets/js/33.40b7751b.js"><link rel="prefetch" href="/assets/js/34.de2fb230.js"><link rel="prefetch" href="/assets/js/4.a66dc1e8.js"><link rel="prefetch" href="/assets/js/5.f0631bf8.js"><link rel="prefetch" href="/assets/js/6.efdee8bf.js"><link rel="prefetch" href="/assets/js/7.9c013080.js"><link rel="prefetch" href="/assets/js/8.33e59ac7.js"><link rel="prefetch" href="/assets/js/9.f2c1974a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.08f75515.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Trefoil</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  前端面试题
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专业课" class="dropdown-title"><span class="title">专业课</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/study/infomation-safe/" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/study/network/" class="nav-link">
  网络编程
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/trefoils/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link router-link-active">
  博客
</a></div><div class="nav-item"><a href="/interview/" class="nav-link">
  前端面试题
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="专业课" class="dropdown-title"><span class="title">专业课</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/study/database/" class="nav-link">
  数据库
</a></li><li class="dropdown-item"><!----> <a href="/study/infomation-safe/" class="nav-link">
  信息安全
</a></li><li class="dropdown-item"><!----> <a href="/study/network/" class="nav-link">
  网络编程
</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">
  关于
</a></div> <a href="https://github.com/trefoils/Blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>基础网络协议</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/network/osi/osi.html" class="sidebar-link">OSI参考模型</a></li><li><a href="/blog/network/osi/osi-dfw.html" class="sidebar-link">OSI模型中数据的传输</a></li><li><a href="/blog/network/tcpip/tcpip.html" class="sidebar-link">TCP/IP参考模型</a></li><li><a href="/blog/network/ip/ip.html" class="sidebar-link">IP</a></li><li><a href="/blog/network/tcp/tcp.html" aria-current="page" class="active sidebar-link">TCP</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/network/tcp/tcp.html#tcp的分段格式" class="sidebar-link">TCP的分段格式</a></li><li class="sidebar-sub-header"><a href="/blog/network/tcp/tcp.html#tcp连接的建立和释放" class="sidebar-link">TCP连接的建立和释放</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/network/tcp/tcp.html#建立连接" class="sidebar-link">建立连接</a></li><li class="sidebar-sub-header"><a href="/blog/network/tcp/tcp.html#数据传输" class="sidebar-link">数据传输</a></li><li class="sidebar-sub-header"><a href="/blog/network/tcp/tcp.html#释放链接" class="sidebar-link">释放链接</a></li></ul></li></ul></li><li><a href="/blog/network/udp/udp.html" class="sidebar-link">UDP</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>前端性能优化</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/web-optimization/web-optimization.html" class="sidebar-link">性能优化</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Mac软件</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/mac/homebrew/brew.html" class="sidebar-link">Homebrew安装</a></li><li><a href="/blog/mac/nvm/nvm.html" class="sidebar-link">nvm的安装使用</a></li><li><a href="/blog/mac/office2019/office2019.html" class="sidebar-link">office2019</a></li><li><a href="/blog/mac/oh-my-zsh/oh-my-zsh.html" class="sidebar-link">oh-my-zsh</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="tcp"><a href="#tcp" class="header-anchor">#</a> TCP</h1> <p>TCP（Transmission Control Protocol，传输控制协议）是面向连接的传输协议，通过序列确认和包重发机制提供可靠的数据流发送和应用程序的虚拟连接服务。TCP和IP相结合，构成了Internet协议的核心。</p> <p>TCP提供应用程序和IP之间的中间层通信服务。当应用程序需要使用IP在网络上发送大量数据时，不需要将数据拆分成一组数据块，然后提交一系列的IP请求，而只要提交一个请求到TCP，由TCP来处理IP的细节。</p> <p>IP数据包是一个字节序列，由包头和后面的包体组成。包头中描述包的目的地址和用来转发到最终目的地址的路由，后者为可选项；包体中包含IP层要传输的数据。由于网络冲突、流量负载均衡和其他不可预见的网络行为，IP包在传输过程中有可能被丢失或打乱顺序。TCP可以检测到这些问题，并要求重新传输丢失的数据包、重新组织被打乱顺序的数据包，甚至可以帮助最小化网络冲突，从而减小发生其他问题的概率。一旦TCP层的接收者最终收到了组织好的最初传输数据的复本，它将发送一个报文给应用程序。这样，使用TCP的应用程序就不需要考虑底层网络通信的细节了。</p> <p>TCP是一个精确传输协议，但并不是及时传输协议。使用TCP传输数据可能会导致相对较长的延时，通常用来等待打乱顺序的消息或者重新传输丢失的消息。因此，TCP并不适用于一些对实时性要求很高的应用程序，如VOIP（Voice over IP，在IP层实现语音通信的协议）。</p> <p>TCP是可靠的流传输服务，它可以保证从一个主机传送到另一个主机的数据流不会出现重复数据或丢失数据的情况。因为在IP中数据包的传输是不可靠的，所以在传输时需要使用一种叫作主动确认技术来确保数据包传输的可靠性。主动确认技术要求接收者在接收到数据后发一个确认消息，发送者会为发送的每个数据包保留一条记录，并且等待收到确认消息后再发送下一个数据包。发送者还会保留一个从发送数据包开始的计时器，如果计时器过期就重新传输数据包，这种情况下通常数据包已经丢失或者被破坏。</p> <p>TCP协议具有以下5个特点。</p> <ol><li><p>TCP是面向连接的协议。即应用程序要使用TCP协议，需要先建立连接，传送数据完成后，需要释放连接。</p></li> <li><p>TCP是点对点协议。即每条TCP连接只能有两个端点，因此每条TCP连接只能是点对点的（只能是一对一）。</p></li> <li><p>TCP提供可靠传输服务。即TCP连接可以实现数据的无差错、不丢失、不重复及按序到达的传输。</p></li> <li><p>TCP提供全双工通信。TCP连接的两端都有接收缓冲区和发送缓冲区，因此可以实现全双工通信。</p></li> <li><p>TCP是面向字节流的协议。与UDP不同，TCP将应用程序交下来的数据仅仅看作一连串的无结构的字节流，TCP并不关心字节流的含义，只保证接收方收到的字节流与发送方发出的字节流一致。</p></li></ol> <h2 id="tcp的分段格式"><a href="#tcp的分段格式" class="header-anchor">#</a> TCP的分段格式</h2> <p>为了更高效地在网络中传输，消息被拆分成一个个消息单元，在网络上的计算机之间传递。消息单元被称为段（Segment）。例如，在浏览网页时，HTML文件从Web服务器发送到客户端。Web服务器端的TCP层将文件的字节序拆分成段，然后将它们独立地传递到Web服务器端的IP层。IP层将TCP段封装成IP数据包，并为每个数据包都添加一个包头，其中包含要到达的目标地址。尽管每个数据包都拥有相同的目标地址，但它们可以经过不同的网络路径到达目标地址。当目标计算机上的客户端程序接收到这些数据包后，TCP层将对各个段进行重组，以确保这些数据包的顺序和内容都是正确的，然后将它们以流的方式传递给应用程序。</p> <p>为了实现面向连接的可靠传输，TCP的分段格式比UDP要复杂</p> <p><img src="/images/network/tcp_head.jpeg" alt="image"></p> <ul><li><p>源端口（16位）：标识发送消息的端口。</p></li> <li><p>目标端口（16位）：标识接收消息的端口。</p></li> <li><p>发送序列号（32位）：本段中第1个数据字节的顺序号。</p></li> <li><p>接收时的确认序列号（32位）：指明接收方期望接收的下一个数据字节的顺序号。</p></li> <li><p>偏移值（4位）：指定TCP段头中32位字的数量。</p></li> <li><p>保留（4位）：为将来使用预留的位，目前使用时将这些位设置为0。</p></li> <li><p>CWR：由发送消息的主机设置，以表明它收到带ECE标记的TCP数据包。</p></li> <li><p>ECE：表明了TCP的对等体在3次握手过程中是否具有拥塞通知能力。当ECE位的值等于1时，表示目的端发生了阻塞。因此在传回发送端的确认包中会将此位设置为1，以通知发送端降低其数据的发送量。</p></li> <li><p>URG：表示发送的数据要立即被处理，无须等待接收设备缓存中的数据完成。</p></li> <li><p>ACK：确认从主机收到TCP数据。</p></li> <li><p>PSH：表示数据包中的数据必须迅速传播到上层协议进行处理。</p></li> <li><p>RST：由于不可能恢复的错误，造成TCP连接重置。当接收到的TCP段中RST位为1时，接收方必须终止连接，这将导致双方立刻重新设置连接，可能导致在传送中丢失数据。RST不是正常关闭TCP连接的方式，它只表明一个异常条件。通常使用FIN标志关闭TCP连接。重新设置TCP连接的原因可能是主机崩溃等。</p></li> <li><p>SYN：打开主机之间虚拟电路的连接。</p></li> <li><p>FIN：结束TCP连接，不再需要数据传输。</p></li> <li><p>窗口大小（16位）：指定发送设备希望接收的字节数。</p></li> <li><p>校验和（16位）：根据报头和数据字段计算出的校验和。</p></li> <li><p>紧急指针（16位）：从发送序列号开始的偏置值，指向字节流中的一个位置，此位置之前的数据是紧急数据。</p></li> <li><p>可选项（长度可变）：目前只有一个可选项，即建立连接时指定的最大段长。</p></li></ul> <h2 id="tcp连接的建立和释放"><a href="#tcp连接的建立和释放" class="header-anchor">#</a> TCP连接的建立和释放</h2> <p>TCP是一个面向连接的可靠的传输控制协议，在每次数据传输之前需要首先建立连接，当连接建立成功后才开始传输数据，数据传输完成后要释放连接，这个过程与打电话类似。由于TCP使用的网络层IP协议是一个不可靠的、无连接的协议，为了确保连接的建立和释放都是可靠的，TCP使用三次握手的方式来建立连接。</p> <div class="custom-block tip"><p class="custom-block-title">Tips</p> <p>TCP连接由操作系统通过Socket开发接口来管理，将会在socket开发开发接口中讨论</p></div> <h3 id="建立连接"><a href="#建立连接" class="header-anchor">#</a> 建立连接</h3> <p>TCP通过3次握手的方式来建立连接，如图所示</p> <p><img src="/images/network/tcp_connect.jpeg" alt="image"></p> <p>建立连接的过程说明如下。</p> <ul><li><p>客户端发送一个SYN报文段（SYN为1）指明希望连接的服务器端口和初始顺序号（ISN）。</p></li> <li><p>服务器发回包含服务器的初始顺序号的SYN报文段（SYN为1）作为应答。同时，将确认号设置为客户端的ISN加1以对客户端的SYN报文段进行确认（ACK字段也为1，表示该报文是对SYN = 1的报文的应答）。</p></li> <li><p>客户端必须将确认号设置为服务器的ISN加1以对服务器的SYN报文段进行确认，该报文通知目的主机双方已完成连接建立。</p></li></ul> <h3 id="数据传输"><a href="#数据传输" class="header-anchor">#</a> 数据传输</h3> <p>TCP是一种可靠的传输协议，它使用序列号来标识数据中的每个字节。序列号中包含每个主机中发送的字节的顺序，从而使目的主机可以按照顺序对数据进行重组。每个字节的序列号是递增的。在建立连接时3次握手的前两次中，两端的主机会交换初始序列号（ISN）。初始序列号是随机的，不可预知的。</p> <p>TCP主要采用累计确认的机制。接收者收到数据后，会发送一个确认包，指定需要接收的下一个字节的序列号。例如，主机A向主机B发送4字节的数据，它们的序列号分别为100、101、102和103，主机B在接收到这4字节后，会向主机A发送一个包含序列号104的确认包，表明它希望接收的下一个字节的序列号为104。</p> <p>除了累计确认外，接收者还可以发送选择确认包。通常在数据丢失或损坏时，接收者发送选择确认包来指定发送者重新发送指定的数据包。</p> <p>TCP使用序列号和确认机制可以丢弃重复数据、重新发送丢失的数据、按正确的顺序来整理数据，从而确保收到数据的正确性。TCP使用检验和（Checksum）来验证数据的正确性。</p> <p>TCP还提供流量控制的功能。如果发送方主机的网卡带宽大于接收方主机的网卡带宽，则要对发送数据的流量进行控制，否则接收方将无法稳定地接收和处理数据。TCP使用滑动窗口来控制流量。在每个TCP段中，接收者都要在“接收窗口大小”字段中指定当前连接希望接收的数据大小，单位是字节。发送方主机最多只能发送“接收窗口大小”字段中指定数量的数据，等收到确认信息后再发送下一组数据。</p> <h3 id="释放链接"><a href="#释放链接" class="header-anchor">#</a> 释放链接</h3> <p>在多数情况下，TCP使用4次握手来断开连接。当一方希望断开连接时，它会向对方发送一个FIN包；对方在收到FIN包后，会发送一个ACK确认包。因此，通常来说双向连接需要从每个TCP端点发送一对FIN和ACK段。</p> <p>TCP也可以使用3次握手的方式断开连接。当主机A发送FIN包后，主机B回复FIN加ACK包，将上面的两个步骤合并为一个步骤，然后主机A再回复ACK包。</p> <p><img src="/images/network/tcp_close.jpeg" alt="image"></p> <ol start="2"><li>第一次挥手：A发送一个FIN，用来关闭A到B的数据传送，A进入FIN_WAIT_1（主动关闭）状态。</li> <li>第二次挥手：B收到FIN后，发送一个ACK给A，确认序号为收到序号+1（与SYN相同，一个FIN占用一个序号），B进入CLOSE_WAIT（被动关闭，关闭等待）状态。</li> <li>第三次挥手：B发送一个FIN，用来关闭B到A的数据传送，B进入LAST_ACK（最后确认）状态。</li> <li>第四次挥手：A收到FIN后，A进入TIME_WAIT状态（注意此时TCP连接还没有释放，必须经过2MSL（最大报文段寿命）的时间），接着发送一个ACK给B，确认序号为收到序号+1，B进入CLOSED状态，完成四次挥手。</li></ol> <div class="custom-block tip"><p class="custom-block-title">关于为什么要等待2MSL：</p> <p>MSL（Maximum Segment Lifetime），这是TCP 对TCP Segment 生存时间的限制。
客户端发送最后一个ACK后，不能确保服务端一定能收到，假如ACK没有被服务端收到，超时后服务端重新进行第三次挥手，这时候如果A还在等待，又收到第三次挥手的FIN消息，证明ACK没有成功到达，这个时间至少是：服务端的超时时间 + FIN的传输时间，为了保证可靠，采用更加保守的等待时间2MSL。
如果客户端此时没有在等待状态直接CLOSED，服务端超时后发送FIN消息到客户端，客户端表示并不知道这数据包是干什么的，所以响应一个RST（用来异常的关闭连接，请自行了解）,如果客户端有一个和服务端的新连接在这个端口上建立。这将可能导致后面建立的连接受到影响，TCP是可靠的连接，所以是不希望这种不靠谱的事情出现的</p></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/trefoils/Blog/edit/master/docs/blog/network/tcp/tcp.md" target="_blank" rel="noopener noreferrer">在 Github 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新时间:</span> <span class="time">8/19/2020, 8:00:16 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/network/ip/ip.html" class="prev">
        IP
      </a></span> <span class="next"><a href="/blog/network/udp/udp.html">
        UDP
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.af13c7e6.js" defer></script><script src="/assets/js/2.0f0c28b9.js" defer></script><script src="/assets/js/17.d3e472d1.js" defer></script>
  </body>
</html>
